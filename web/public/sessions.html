<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Session Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', 'Consolas', monospace;
      background: #0a0a0a;
      color: #c9c9c9;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #1a1a1a;
    }

    .header-left h1 {
      color: #ffb000;
      font-size: 20px;
      font-weight: normal;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .header-left .subtitle {
      color: #666666;
      font-size: 11px;
      margin-top: 4px;
    }

    .stats-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-item {
      background: #0f0f0f;
      border: 1px solid #1a1a1a;
      padding: 10px 15px;
      border-radius: 2px;
    }

    .stat-label {
      color: #666666;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-value {
      color: #33ff33;
      font-size: 18px;
      font-weight: bold;
    }

    .stat-value.warning {
      color: #ffbb00;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-label {
      color: #666666;
      font-size: 11px;
      text-transform: uppercase;
    }

    select, button, input {
      background: #0f0f0f;
      color: #c9c9c9;
      border: 1px solid #1a1a1a;
      padding: 6px 12px;
      font-size: 11px;
      font-family: 'Courier New', monospace;
      cursor: pointer;
    }

    input {
      cursor: text;
    }

    select:focus, button:focus, input:focus {
      outline: none;
      border-color: #ffb000;
    }

    button:hover {
      background: #1a1a1a;
    }

    .btn-primary {
      border-color: #33ff33;
      color: #33ff33;
    }

    .btn-primary:hover {
      background: #33ff33;
      color: #0a0a0a;
    }

    .btn-danger {
      border-color: #ff3333;
      color: #ff3333;
    }

    .btn-danger:hover {
      background: #ff3333;
      color: #0a0a0a;
    }

    /* Navigation */
    .nav {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
    }

    .nav a {
      color: #666666;
      text-decoration: none;
      padding: 8px 16px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: 1px solid transparent;
    }

    .nav a:hover, .nav a.active {
      color: #ffb000;
      border-color: #1a1a1a;
    }

    /* Section */
    .section {
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .section-title {
      color: #ffb000;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .section-count {
      color: #666666;
      font-size: 11px;
    }

    /* Session Grid */
    .session-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 15px;
    }

    .session-card {
      background: #0f0f0f;
      border: 1px solid #1a1a1a;
      padding: 15px;
      transition: border-color 0.2s;
    }

    .session-card:hover {
      border-color: #ffb000;
    }

    .session-card.status-active {
      border-left: 3px solid #33ff33;
    }

    .session-card.status-terminated {
      border-left: 3px solid #666666;
    }

    .session-card.status-crashed {
      border-left: 3px solid #ff3333;
    }

    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .session-agent {
      font-size: 14px;
      color: #ffb000;
    }

    .session-id {
      font-size: 10px;
      color: #666666;
      font-family: 'Courier New', monospace;
      margin-top: 4px;
    }

    .status-badge {
      padding: 3px 8px;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: 1px solid;
    }

    .status-active {
      color: #33ff33;
      border-color: #33ff33;
    }

    .status-terminated {
      color: #666666;
      border-color: #666666;
    }

    .status-crashed {
      color: #ff3333;
      border-color: #ff3333;
    }

    .session-info {
      font-size: 11px;
      color: #666666;
      line-height: 1.8;
    }

    .session-info-row {
      display: flex;
      justify-content: space-between;
    }

    .session-info-label {
      color: #666666;
    }

    .session-info-value {
      color: #c9c9c9;
      text-align: right;
      max-width: 60%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .session-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #1a1a1a;
    }

    .session-actions button {
      flex: 1;
      padding: 5px 10px;
      font-size: 10px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #666666;
      background: #0f0f0f;
      border: 1px solid #1a1a1a;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 20px;
      color: #333333;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 60px;
      color: #666666;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #1a1a1a;
      border-top-color: #ffb000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 2000;
    }

    .toast {
      background: #0f0f0f;
      border: 1px solid #1a1a1a;
      padding: 12px 20px;
      margin-top: 10px;
      font-size: 11px;
      animation: slideIn 0.2s ease;
    }

    .toast.success {
      border-color: #33ff33;
      color: #33ff33;
    }

    .toast.error {
      border-color: #ff3333;
      color: #ff3333;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <nav class="nav">
      <a href="/sessions.html" class="active">Sessions</a>
      <a href="/agents.html">Agents</a>
      <a href="/configs.html">Configs</a>
    </nav>

    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <h1>Session Dashboard</h1>
        <p class="subtitle">Monitor active and archived Claude Code sessions</p>
      </div>
      <div>
        <button class="btn-primary" onclick="refreshSessions()">[R] Refresh</button>
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-label">Active Sessions</div>
        <div class="stat-value" id="stat-active">-</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Total Archived</div>
        <div class="stat-value" id="stat-archived">-</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Today</div>
        <div class="stat-value" id="stat-today">-</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">This Week</div>
        <div class="stat-value" id="stat-week">-</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <span class="filter-label">Agent:</span>
        <select id="filter-agent" onchange="applyFilters()">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Status:</span>
        <select id="filter-status" onchange="applyFilters()">
          <option value="">All</option>
          <option value="active">Active</option>
          <option value="terminated">Terminated</option>
          <option value="crashed">Crashed</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Directory:</span>
        <input type="text" id="filter-directory" placeholder="Filter by path..." onkeyup="applyFilters()" style="width: 200px;">
      </div>
      <div class="filter-group">
        <span class="filter-label">Limit:</span>
        <select id="filter-limit" onchange="loadArchivedSessions()">
          <option value="20">20</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>

    <!-- Active Sessions Section -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Active Sessions</h2>
        <span class="section-count" id="active-count">0 sessions</span>
      </div>
      <div id="active-sessions-grid" class="session-grid">
        <div class="loading">
          <div class="spinner"></div>
          <p style="margin-top: 10px;">Loading active sessions...</p>
        </div>
      </div>
    </div>

    <!-- Archived Sessions Section -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Archived Sessions</h2>
        <span class="section-count" id="archived-count">0 sessions</span>
      </div>
      <div id="archived-sessions-grid" class="session-grid">
        <div class="loading">
          <div class="spinner"></div>
          <p style="margin-top: 10px;">Loading archived sessions...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <script>
    const DAEMON_API = 'http://127.0.0.1:3000/api';
    let activeSessions = [];
    let archivedSessions = [];
    let allAgents = new Set();
    let ws = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadActiveSessions();
      loadArchivedSessions();
      connectWebSocket();
    });

    // Load active sessions
    async function loadActiveSessions() {
      try {
        const response = await fetch(`${DAEMON_API}/sessions/active`);
        if (!response.ok) {
          throw new Error('Failed to load active sessions');
        }
        activeSessions = await response.json();

        // Collect agent names
        activeSessions.forEach(s => allAgents.add(s.agent_name));

        updateAgentFilter();
        applyFilters();
        updateStats();
      } catch (error) {
        console.error('Error loading active sessions:', error);
        showEmptyState('active-sessions-grid', 'Failed to load active sessions', true);
      }
    }

    // Load archived sessions
    async function loadArchivedSessions() {
      try {
        const limit = document.getElementById('filter-limit').value;
        const response = await fetch(`${DAEMON_API}/sessions/archive?limit=${limit}`);
        if (!response.ok) {
          throw new Error('Failed to load archived sessions');
        }
        archivedSessions = await response.json();

        // Collect agent names
        archivedSessions.forEach(s => allAgents.add(s.agent_name));

        updateAgentFilter();
        applyFilters();
        updateStats();
      } catch (error) {
        console.error('Error loading archived sessions:', error);
        showEmptyState('archived-sessions-grid', 'Failed to load archived sessions', true);
      }
    }

    // Update agent filter dropdown
    function updateAgentFilter() {
      const select = document.getElementById('filter-agent');
      const currentValue = select.value;

      // Keep "All" option and add agents
      const options = ['<option value="">All</option>'];
      Array.from(allAgents).sort().forEach(agent => {
        options.push(`<option value="${agent}">${escapeHtml(agent)}</option>`);
      });

      select.innerHTML = options.join('');
      select.value = currentValue;
    }

    // Apply filters
    function applyFilters() {
      const agentFilter = document.getElementById('filter-agent').value;
      const statusFilter = document.getElementById('filter-status').value;
      const directoryFilter = document.getElementById('filter-directory').value.toLowerCase();

      // Filter active sessions
      let filteredActive = [...activeSessions];
      if (agentFilter) {
        filteredActive = filteredActive.filter(s => s.agent_name === agentFilter);
      }
      if (statusFilter) {
        filteredActive = filteredActive.filter(s => s.status === statusFilter);
      }
      if (directoryFilter) {
        filteredActive = filteredActive.filter(s =>
          s.working_directory && s.working_directory.toLowerCase().includes(directoryFilter)
        );
      }

      // Filter archived sessions
      let filteredArchived = [...archivedSessions];
      if (agentFilter) {
        filteredArchived = filteredArchived.filter(s => s.agent_name === agentFilter);
      }
      if (statusFilter) {
        filteredArchived = filteredArchived.filter(s => s.status === statusFilter);
      }
      if (directoryFilter) {
        filteredArchived = filteredArchived.filter(s =>
          s.working_directory && s.working_directory.toLowerCase().includes(directoryFilter)
        );
      }

      renderSessions('active-sessions-grid', filteredActive, 'active-count');
      renderSessions('archived-sessions-grid', filteredArchived, 'archived-count');
    }

    // Render sessions
    function renderSessions(gridId, sessions, countId) {
      const grid = document.getElementById(gridId);
      const countEl = document.getElementById(countId);

      countEl.textContent = `${sessions.length} session${sessions.length !== 1 ? 's' : ''}`;

      if (sessions.length === 0) {
        showEmptyState(gridId, 'No sessions found');
        return;
      }

      grid.innerHTML = sessions.map(session => createSessionCard(session)).join('');
    }

    // Create session card HTML
    function createSessionCard(session) {
      const startTime = new Date(session.start_time);
      const endTime = session.end_time ? new Date(session.end_time) : null;
      const duration = endTime
        ? formatDuration(endTime - startTime)
        : formatDuration(Date.now() - startTime);

      const isActive = session.status === 'active';
      const statusClass = `status-${session.status}`;

      return `
        <div class="session-card ${statusClass}">
          <div class="session-header">
            <div>
              <div class="session-agent">${escapeHtml(session.agent_name)}</div>
              <div class="session-id">${session.session_id.slice(0, 24)}...</div>
            </div>
            <span class="status-badge ${statusClass}">${session.status}</span>
          </div>
          <div class="session-info">
            <div class="session-info-row">
              <span class="session-info-label">PID:</span>
              <span class="session-info-value">${session.pid}</span>
            </div>
            <div class="session-info-row">
              <span class="session-info-label">Duration:</span>
              <span class="session-info-value">${duration}</span>
            </div>
            <div class="session-info-row">
              <span class="session-info-label">Started:</span>
              <span class="session-info-value">${formatDateTime(startTime)}</span>
            </div>
            ${endTime ? `
            <div class="session-info-row">
              <span class="session-info-label">Ended:</span>
              <span class="session-info-value">${formatDateTime(endTime)}</span>
            </div>
            ` : ''}
            <div class="session-info-row">
              <span class="session-info-label">Directory:</span>
              <span class="session-info-value" title="${escapeHtml(session.working_directory)}">${escapeHtml(session.working_directory)}</span>
            </div>
            ${session.git_repo ? `
            <div class="session-info-row">
              <span class="session-info-label">Git:</span>
              <span class="session-info-value">${escapeHtml(session.git_repo)}${session.git_branch ? ` (${session.git_branch})` : ''}</span>
            </div>
            ` : ''}
          </div>
          <div class="session-actions">
            <button onclick="viewSession('${session.session_id}', ${isActive})">View Details</button>
            ${isActive ? `
            <button class="btn-danger" onclick="terminateSession('${session.session_id}')">Terminate</button>
            ` : ''}
          </div>
        </div>
      `;
    }

    // Update stats
    function updateStats() {
      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

      const todayCount = archivedSessions.filter(s =>
        new Date(s.start_time) >= todayStart
      ).length;

      const weekCount = archivedSessions.filter(s =>
        new Date(s.start_time) >= weekStart
      ).length;

      document.getElementById('stat-active').textContent = activeSessions.length;
      document.getElementById('stat-archived').textContent = archivedSessions.length;
      document.getElementById('stat-today').textContent = todayCount;
      document.getElementById('stat-week').textContent = weekCount;
    }

    // Show empty state
    function showEmptyState(gridId, message, isError = false) {
      document.getElementById(gridId).innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">${isError ? '[!]' : '[ ]'}</div>
          <h3>${message}</h3>
          <p style="margin-top: 10px;">
            ${isError
              ? 'Make sure the Daemon is running.'
              : 'Sessions will appear here when they are created.'}
          </p>
        </div>
      `;
    }

    // View session details
    function viewSession(sessionId, isActive) {
      const endpoint = isActive ? 'active' : 'archive';
      window.open(`/session-detail.html?id=${sessionId}&type=${endpoint}`, '_blank');
    }

    // Terminate session
    async function terminateSession(sessionId) {
      if (!confirm('Are you sure you want to terminate this session?')) {
        return;
      }

      try {
        const response = await fetch(`${DAEMON_API}/sessions/${sessionId}/terminate`, {
          method: 'POST',
        });

        if (!response.ok) {
          throw new Error('Failed to terminate session');
        }

        showToast('Session terminated successfully', 'success');
        setTimeout(() => {
          loadActiveSessions();
          loadArchivedSessions();
        }, 1000);
      } catch (error) {
        console.error('Error terminating session:', error);
        showToast('Failed to terminate session: ' + error.message, 'error');
      }
    }

    // Refresh sessions
    function refreshSessions() {
      loadActiveSessions();
      loadArchivedSessions();
    }

    // WebSocket connection for real-time updates
    function connectWebSocket() {
      const wsUrl = `ws://${window.location.hostname}:3000/ws`;

      try {
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          console.log('WebSocket connected');
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);

          if (data.type === 'session_registered' || data.type === 'session_unregistered') {
            loadActiveSessions();
          }

          if (data.type === 'session_update') {
            loadArchivedSessions();
          }
        };

        ws.onclose = () => {
          console.log('WebSocket disconnected, will retry in 5s');
          setTimeout(connectWebSocket, 5000);
        };

        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
        };
      } catch (error) {
        console.error('Failed to connect WebSocket:', error);
      }
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Utility functions
    function formatDuration(ms) {
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (days > 0) {
        return `${days}d ${hours % 24}h`;
      }
      if (hours > 0) {
        return `${hours}h ${minutes % 60}m`;
      }
      if (minutes > 0) {
        return `${minutes}m ${seconds % 60}s`;
      }
      return `${seconds}s`;
    }

    function formatDateTime(date) {
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) {
        return 'Just now';
      }
      if (diff < 3600000) {
        return `${Math.floor(diff / 60000)}m ago`;
      }
      if (diff < 86400000) {
        return `${Math.floor(diff / 3600000)}h ago`;
      }

      return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
